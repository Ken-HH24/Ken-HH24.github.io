<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="previewTree 树形控件是我实习的时候封装的第一个组件。但是在当时， 渲染节点数量控制 ，节点信息修改 ，组件代码结构 这些问题以自己的能力都很难完美解决，也导致在最后的答辩中的失利。 现在来复盘一下该组件应该如何设计，并借鉴 github 上的 semi design ，阅读一下企业组件库的源码是如何设计 Tree 树形控件的。  https:&#x2F;&#x2F;github.com&#x2F;Ken-HH24&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Component - Tree树形控件">
<meta property="og:url" content="http://example.com/2021/12/08/Component%20-%20Tree%E6%A0%91%E5%BD%A2%E6%8E%A7%E4%BB%B6/index.html">
<meta property="og:site_name" content="Ken&#39;s blog">
<meta property="og:description" content="previewTree 树形控件是我实习的时候封装的第一个组件。但是在当时， 渲染节点数量控制 ，节点信息修改 ，组件代码结构 这些问题以自己的能力都很难完美解决，也导致在最后的答辩中的失利。 现在来复盘一下该组件应该如何设计，并借鉴 github 上的 semi design ，阅读一下企业组件库的源码是如何设计 Tree 树形控件的。  https:&#x2F;&#x2F;github.com&#x2F;Ken-HH24&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-12-08T02:27:05.000Z">
<meta property="article:modified_time" content="2021-12-22T02:41:06.503Z">
<meta property="article:author" content="Ken">
<meta property="article:tag" content="Component">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2021/12/08/Component%20-%20Tree%E6%A0%91%E5%BD%A2%E6%8E%A7%E4%BB%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Component - Tree树形控件 | Ken's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ken's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/08/Component%20-%20Tree%E6%A0%91%E5%BD%A2%E6%8E%A7%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ken">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ken's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Component - Tree树形控件
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-08 10:27:05" itemprop="dateCreated datePublished" datetime="2021-12-08T10:27:05+08:00">2021-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-22 10:41:06" itemprop="dateModified" datetime="2021-12-22T10:41:06+08:00">2021-12-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="preview"><a href="#preview" class="headerlink" title="preview"></a>preview</h1><p><strong>Tree</strong> 树形控件是我实习的时候封装的第一个组件。但是在当时， <strong>渲染节点数量控制</strong> ，<strong>节点信息修改</strong> ，<strong>组件代码结构</strong> 这些问题以自己的能力都很难完美解决，也导致在最后的答辩中的失利。</p>
<p>现在来复盘一下该组件应该如何设计，并借鉴 <strong>github</strong> 上的 <strong>semi design</strong> ，阅读一下企业组件库的源码是如何设计 <strong>Tree</strong> 树形控件的。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ken-HH24/Ken-HH24.github.io/tree/demo-typescript/src/components/Tree">https://github.com/Ken-HH24/Ken-HH24.github.io/tree/demo-typescript/src/components/Tree</a></li>
</ul>
<hr>
<h1 id="data-structure"><a href="#data-structure" class="headerlink" title="data structure"></a>data structure</h1><p>首先要考虑到组件所接收的 <strong>treeData</strong> 数据结构，在实习的时候，由于后台接口原因，数据是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> treeData = [</span><br><span class="line">    &#123; <span class="attr">label</span>: <span class="string">&#x27;亚洲&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Asia&#x27;</span>, <span class="attr">key</span>: <span class="string">&#x27;0&#x27;</span>, <span class="attr">parent</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">label</span>: <span class="string">&#x27;中国&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;China&#x27;</span>, <span class="attr">key</span>: <span class="string">&#x27;0-0&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;0&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">label</span>: <span class="string">&#x27;日本&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Japan&#x27;</span>, <span class="attr">key</span>: <span class="string">&#x27;0-1&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;0&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">label</span>: <span class="string">&#x27;北美洲&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;North America&#x27;</span>, <span class="attr">key</span>: <span class="string">&#x27;1&#x27;</span>, <span class="attr">parent</span>: <span class="literal">null</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>扁平化的数据就意味着还要在前端里将其转化为树形数据结构，基本思路也很简单，建立一个 <strong>Map</strong> 存储 <strong>[key: string]: treeNode</strong> 键值对，然后遍历 <strong>treeData</strong> 每次通过 <strong>parent</strong> 字段在 <strong>Map</strong> 中找到对应的祖先节点即可。</p>
<p>转化完成后就与 <strong>semi design</strong> 要求的数据结构基本一致了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> treeData = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&#x27;亚洲&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;Asia&#x27;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&#x27;中国&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: <span class="string">&#x27;China&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;0-0&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&#x27;日本&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: <span class="string">&#x27;Japan&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;0-1&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&#x27;北美洲&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;North America&#x27;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<hr>
<span id="more"></span>

<h1 id="渲染方式"><a href="#渲染方式" class="headerlink" title="渲染方式"></a>渲染方式</h1><p>有了基本的数据结构就可以着手渲染了，实习的时候缺乏经验，直接递归组件全量渲染，依托于 <strong>vue</strong> 里面的 <strong>v-if</strong> 进行控制：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&#x27;tree-node&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;right-arrow&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&#x27;children.length&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TreeNode</span> <span class="attr">v-for</span>=<span class="string">&#x27;child in children&#x27;</span> <span class="attr">:key</span>=<span class="string">&#x27;child.key&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样做的缺点是由于采用递归，导致节点渲染不可控，嵌套的 <strong>DOM</strong> 结构会让页面处理比如 <strong>CSS</strong> 变得复杂。</p>
<p>而 <strong>semi-design</strong> 采取的方法是通过传入的 <strong>treeData</strong> 以及各个节点的展开状态，维护一个 <strong>expandedKeys</strong> 的 <strong>Set</strong> ，通过该 <strong>expandedKeys</strong> 再生成真正需要渲染的节点数组 <strong>flattenNodes</strong> ，避免了一开始就需要渲染成千上万的节点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; flattenNodes, motionType, renderTreeNode &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="comment">// 动画处理节点列表</span></span><br><span class="line">    <span class="keyword">const</span> &#123; transitionNodes &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="comment">// 最终渲染节点列表</span></span><br><span class="line">    <span class="keyword">const</span> mapData = transitionNodes.length ? transitionNodes : flattenNodes;</span><br><span class="line">    <span class="keyword">const</span> options = mapData.map(<span class="function"><span class="params">treeNode</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否需要动画处理</span></span><br><span class="line">        <span class="keyword">const</span> isMotionNode = <span class="built_in">Array</span>.isArray(treeNode);</span><br><span class="line">        <span class="comment">// 无节点需要处理</span></span><br><span class="line">        <span class="keyword">if</span> (isMotionNode &amp;&amp; !(treeNode <span class="keyword">as</span> FlattenNode[]).length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isMotionNode &amp;&amp; (treeNode <span class="keyword">as</span> FlattenNode[]).length) &#123;</span><br><span class="line">            <span class="keyword">const</span> nodeKey = getTreeNodeKey(treeNode[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// 动画处理</span></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="xml"><span class="tag">&lt;<span class="name">Collapse</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">motionType</span>=<span class="string">&#123;motionType</span> === <span class="string">&#x27;show&#x27;</span> ? &#x27;<span class="attr">enter</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">leave</span>&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">key</span>=<span class="string">&#123;</span>`<span class="attr">motion-</span>$&#123;<span class="attr">nodeKey</span>&#125;`&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onMotionEnd</span>=<span class="string">&#123;this.onMotionEnd&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">motion</span>=<span class="string">&#123;Boolean(motionType)&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                &gt;</span></span></span><br><span class="line"><span class="xml">                    &#123;treeNode.map(node =&gt; renderTreeNode(node))&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">Collapse</span>&gt;</span></span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 正常节点处理</span></span><br><span class="line">        <span class="keyword">return</span> renderTreeNode(treeNode <span class="keyword">as</span> FlattenNode);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="F-A-架构"><a href="#F-A-架构" class="headerlink" title="F / A 架构"></a>F / A 架构</h1><p>在实现组件之前，通过阅读 <strong>semi design</strong> 的源码，会发现其经常需要一个 <strong>foundation</strong> 对象帮助其实现功能，而 <strong>foundation</strong> 自身又依靠于组件内部的 <strong>adapter</strong> 。在刚刚看到这部分代码的时候，我的想法是利用这二者将组件的逻辑抽取出来进行复用，但是如果要达到这个目的，建立一个基类使用继承其实也是可以做到的。</p>
<p>其官方称这是 <strong>semi design</strong> 采取的 <strong>F / A 架构</strong>，对于 <strong>Foundation</strong> 和 <strong>Adapter</strong> 有以下定义：</p>
<ul>
<li><p>Foundation</p>
<blockquote>
<p>Foundation 包含最能代表 Semi Design 组件交互的业务逻辑，包括UI行为触发后的各种计算、分支判断等逻辑，它并不直接操作或者引用DOM，任意需要DOM操作，驱动组件渲染更新的部分会委派给Adapter执行。</p>
</blockquote>
</li>
<li><p>Adapter</p>
<blockquote>
<p>Adapter 是一个接口，具有 Foundation 实现 Semi Design 业务逻辑所需的所有方法，并负责 1. 组件DOM结构声明 2.负责所有跟DOM操作/更新相关的逻辑，通常会使用框架API进行setState、getState、addEventListener、removeListener等操作</p>
</blockquote>
</li>
</ul>
<p>也就是 <strong>Foundation</strong> 负责的是组件的 <strong>基本职责</strong> ，如一个 <strong>Tree树形控件</strong> 里都要负责节点的展开，因此 <strong>onExpandNode</strong> 的这个职责就交给 <strong>foundation.handleNodeExpand()</strong> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tree.ts</span></span><br><span class="line"><span class="comment">// 职责交给Foundation</span></span><br><span class="line">onNodeExpand = <span class="function">(<span class="params">e: MouseEvent, treeNode: TreeNodeProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.foundation.handleNodeExpand(e, treeNode);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是在处理过程中 <strong>Foundation</strong> 需要组件内部的数据如前面提到的 <strong>expandedKeys</strong> ，此时就需要依托于 <strong>Adapter</strong> 提供，而这个时候使用 <strong>Adapter</strong> 的优势就显现出来了，无论是应对多种框架，还是不同的树形控件，例如带选项框的，带搜索功能的，通过组件 <strong>Adapter</strong> 的不同都能满足不同的需求，另外还通过 <strong>Foundation</strong> 保证了组件的基本功能。比通过继承实现要灵活不少。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TreeFoundation.ts</span></span><br><span class="line"><span class="function"><span class="title">handleNodeExpand</span>(<span class="params">e: any, treeNode: BasicTreeNodeProps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; loadData &#125; = <span class="built_in">this</span>.getProps();</span><br><span class="line">    <span class="keyword">if</span> (!loadData &amp;&amp; (!treeNode.children || !treeNode.children.length)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; expandedKeys, data, expanded &#125; = <span class="built_in">this</span>.setExpandedStatus(treeNode);</span><br><span class="line">    <span class="comment">// 依托于adapter</span></span><br><span class="line">    <span class="built_in">this</span>._adapter.notifyExpand(expandedKeys, &#123;</span><br><span class="line">        expanded,</span><br><span class="line">        <span class="attr">node</span>: data,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a>Tree</h1><p>有了以上概念就可以模仿 <strong>semi design</strong> 实现组件了，<strong>Tree</strong> 是整个组件的组织者，所以所有关于树形控件的数据都应该交由他管理，再通过 <strong>Context</strong> 将数据传给子节点。</p>
<h2 id="Data-Structure"><a href="#Data-Structure" class="headerlink" title="Data Structure"></a>Data Structure</h2><table>
<thead>
<tr>
<th>Data</th>
<th>Function</th>
</tr>
</thead>
<tbody><tr>
<td>treeData</td>
<td>用户所传入的树形数据</td>
</tr>
<tr>
<td>expandedKeys</td>
<td>维护展开节点 <strong>key</strong> 的数据结构 <strong>Set</strong></td>
</tr>
<tr>
<td>flattenNodes</td>
<td><strong>treeData</strong> 转化后的扁平化数据</td>
</tr>
<tr>
<td>cachedFlattenNodes</td>
<td>缓存组件上一次的 <strong>flattenNodes</strong></td>
</tr>
<tr>
<td>keyEntities</td>
<td>维护扁平化数据与 <strong>key</strong> 的数据结构 <strong>Map</strong></td>
</tr>
<tr>
<td>posEntities</td>
<td>维护扁平化数据与 <strong>pos</strong> 的数据结构 <strong>Map</strong></td>
</tr>
</tbody></table>
<h2 id="getDerivedStateFromProps"><a href="#getDerivedStateFromProps" class="headerlink" title="getDerivedStateFromProps"></a>getDerivedStateFromProps</h2><p>上面提到的 <strong>flattenNodes</strong> ，<strong>keyEntities</strong> 这些数据，都是由 <strong>treeData</strong> 转化而来的，而这些属性又要保存到组件状态里，在这里可以使用 <strong>React Class Component</strong> 中的生命周期函数 <strong>getDerivedStateFromProps</strong> ，在该函数里进行数据转化的工作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">props, prevState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; treeData &#125; = props;</span><br><span class="line">    <span class="comment">// 需要使用到expandedKeys</span></span><br><span class="line">    <span class="keyword">const</span> &#123; expandedKeys &#125; = prevState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同时转化为keyEntities和posEntities</span></span><br><span class="line">    <span class="keyword">const</span> entities = convertDataToEntities(treeData, expandedKeys);</span><br><span class="line">    <span class="comment">// 转化为扁平化数据flattenNodes</span></span><br><span class="line">    <span class="keyword">const</span> flattenNodes = flattenTreeData(treeData, expandedKeys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回新的状态</span></span><br><span class="line">    <span class="keyword">const</span> newState = &#123;</span><br><span class="line">        <span class="attr">entities</span>: entities,</span><br><span class="line">        <span class="attr">keyEntities</span>: entities.keyEntities,</span><br><span class="line">        <span class="attr">posEntities</span>: entities.posEntities,</span><br><span class="line">        flattenNodes,</span><br><span class="line">        <span class="attr">cachedFlattenNodes</span>: prevState.flattenNodes</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="convertDataToEntities"><a href="#convertDataToEntities" class="headerlink" title="convertDataToEntities"></a>convertDataToEntities</h3><p>该函数主要的任务就是将 <strong>treeData</strong> 与其 <strong>key</strong> 和 <strong>pos</strong> 联系起来，然后存储到 <strong>Map</strong> 数据结构里，同时在遍历 <strong>treeData</strong> 的过程中，为其添加 <strong>parent</strong> 等信息。</p>
<p>该函数主要用到一个 <strong>traverseDataNodes</strong> 的函数，该函数的设计颇为巧妙，在遍历 <strong>treeData</strong> 时采用 <strong>递归DFS</strong> ，递归函数里保留父节点的信息，然后按照父节点信息扩展一系列如 <strong>level</strong> ， <strong>pos</strong> 等信息。另外还接收一个回调函数作为参数，当信息扩展完毕后，将处理完的节点信息传入回调函数中，此时 <strong>convertDataToEntities</strong> 就可以通过该回调函数将新节点信息保存在 <strong>keyEntities</strong> 和 <strong>posEntities</strong> 里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">parentPos, index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;parentPos&#125;</span>-<span class="subst">$&#123;index&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">convertDataToEntities</span>(<span class="params">dataNodes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> posEntities = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> keyEntities = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> wrapper = &#123;</span><br><span class="line">        posEntities,</span><br><span class="line">        keyEntities,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    traverseDataNodes(dataNodes, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 获取新节点信息</span></span><br><span class="line">        <span class="keyword">const</span> &#123; pos, key, parentPos &#125; = data;</span><br><span class="line">        <span class="keyword">const</span> entity = &#123; ...data &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存在对应entities里</span></span><br><span class="line">        posEntities[pos] = entity;</span><br><span class="line">        keyEntities[key] = entity;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标记parent</span></span><br><span class="line">        entity.parent = posEntities[parentPos];</span><br><span class="line">        <span class="comment">// 如果存在parent，那么parent节点的children也需要更新</span></span><br><span class="line">        <span class="keyword">if</span> (entity.parent) &#123;</span><br><span class="line">            entity.parent.children = entity.parent.children || [];</span><br><span class="line">            entity.parent.children.push(entity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">traverseDataNodes</span>(<span class="params">treeNodes, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> processNode = <span class="function">(<span class="params">node, index, parent</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 无node，即第一次遍历，从treeNodes数组开始</span></span><br><span class="line">        <span class="keyword">const</span> children = node ? node.children : treeNodes;</span><br><span class="line">        <span class="keyword">const</span> pos = node ? getPosition(parent.pos, index) : <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node) &#123;</span><br><span class="line">            <span class="comment">// 根据parent扩展一系列信息</span></span><br><span class="line">            <span class="keyword">const</span> data = &#123;</span><br><span class="line">                <span class="attr">data</span>: &#123; ...node &#125;,</span><br><span class="line">                index,</span><br><span class="line">                pos,</span><br><span class="line">                <span class="attr">level</span>: parent ? parent.level + <span class="number">1</span> : <span class="number">1</span>,</span><br><span class="line">                <span class="attr">key</span>: node.key || pos,</span><br><span class="line">                <span class="attr">parentPos</span>: parent ? parent.pos : <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行回调函数</span></span><br><span class="line">            callback(data)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (children) &#123;</span><br><span class="line">            <span class="comment">// 遍历children，递归调用</span></span><br><span class="line">            children.forEach(<span class="function">(<span class="params">subNode, subIndex</span>) =&gt;</span> &#123;</span><br><span class="line">                processNode(subNode, subIndex, &#123;</span><br><span class="line">                    node,</span><br><span class="line">                    pos,</span><br><span class="line">                    <span class="comment">// 无parent，即为根节点，level应该为0</span></span><br><span class="line">                    <span class="attr">level</span>: parent ? <span class="built_in">Number</span>(parent.level) + <span class="number">1</span> : -<span class="number">1</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    processNode(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flattenTreeData"><a href="#flattenTreeData" class="headerlink" title="flattenTreeData"></a>flattenTreeData</h3><p>该函数的作用主要是通过 <strong>expandedKeys</strong> 和 <strong>treeData</strong> ，计算出当前页面应该展示哪一些节点信息，并将他们扁平化处理。主要的思路也是通过 <strong>递归DFS</strong> 利用 <strong>expandedKeys.has(key)</strong> 判断子节点是否应该展示，然后相应地递归调用函数，最后更新到对应父节点的 <strong>children</strong> 属性里</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flattenTreeData</span>(<span class="params">treeNodeList, expandedKeys</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> flattenList = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> flatten = <span class="function">(<span class="params">list, parent = <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.map(<span class="function">(<span class="params">treeNode, index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 扩展信息</span></span><br><span class="line">            <span class="keyword">const</span> flattenNode = &#123;</span><br><span class="line">                ...treeNode,</span><br><span class="line">                <span class="attr">pos</span>: getPosition(parent ? parent.pos : <span class="string">&#x27;0&#x27;</span>, index),</span><br><span class="line">                <span class="attr">level</span>: parent ? parent.level + <span class="number">1</span> : <span class="number">0</span>,</span><br><span class="line">                <span class="attr">children</span>: [],</span><br><span class="line">                parent,</span><br><span class="line">                <span class="attr">data</span>: treeNode</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加到结果数组里</span></span><br><span class="line">            flattenList.push(flattenNode);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果该节点展开，那么子节点也应该展示，所以递归调用函数</span></span><br><span class="line">            <span class="keyword">if</span> (expandedKeys.has(flattenNode.key)) &#123;</span><br><span class="line">                flattenNode.children = flatten(treeNode.children, flattenNode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                flattenNode.children = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> flattenNode;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flatten(treeNodeList);</span><br><span class="line">    <span class="keyword">return</span> flattenList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Foundation"><a href="#Foundation" class="headerlink" title="Foundation"></a>Foundation</h2><p>前面提到了 <strong>semi design</strong> 采用的是 <strong>F / A 架构</strong> ，所以也应该把 <strong>Tree</strong> 的基本处理逻辑放在 <strong>TreeFoundation</strong> 里面。在这里主要讲的是节点展开事件，处理该事件的逻辑是：</p>
<ol>
<li>传入被点击节点的 <strong>treeNode</strong> ，获取其 <strong>key</strong> 值</li>
<li>获取组件的 <strong>expandedKeys</strong> 信息，并检查 <strong>key</strong> 是否在里面，如果有则删除，无则添加</li>
<li>更新组件的状态</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handleNodeExpand</span>(<span class="params">e, treeNode</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取组件内信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123; expandedKeys = <span class="keyword">new</span> <span class="built_in">Set</span>(), keyEntities &#125; = <span class="built_in">this</span>.getStates() || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; eventKey, expanded &#125; = treeNode;</span><br><span class="line">    <span class="comment">// copy一份expandedKeys</span></span><br><span class="line">    <span class="keyword">const</span> newExpandedKeys = <span class="keyword">new</span> <span class="built_in">Set</span>(expandedKeys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应添加或删除</span></span><br><span class="line">    <span class="keyword">if</span> (!expanded) &#123;</span><br><span class="line">        newExpandedKeys.add(eventKey);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newExpandedKeys.delete(eventKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过adapter更新状态</span></span><br><span class="line">    <span class="built_in">this</span>._adapter.updateState(&#123;</span><br><span class="line">        <span class="attr">expandedKeys</span>: newExpandedKeys,</span><br><span class="line">        motionType,</span><br><span class="line">        motionKeys</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一整套流程对于 <strong>Tree</strong> 这个树形控件大类来说都是相同的，不同的只是获取与更新状态的方式，而在本次实现的组件里 <strong>adapter</strong> 较为简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title">adapter</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">getState</span>: <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.state[key];</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">getStates</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.state;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">updateState</span>: <span class="function">(<span class="params">states, cb</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.setState(&#123; ...states &#125;, cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是要注意 <strong>this</strong> 的指向问题，因为该 <strong>adapter</strong> 调用的 <strong>setState</strong> 是 <strong>Class Component</strong> 里面的方法，并非自身的方法，所以需要依赖箭头函数实现。</p>
<p>另外，在 <strong>semi design</strong> 源码里 <strong>adapter</strong> 还承接了许多任务，例如在 <strong>Foundation</strong> 的 <strong>handleNodeExpand</strong> 函数末尾会调用 <strong>adapter</strong> 的 <strong>notifyExpand</strong> 方法，也就是告知组件外部的使用者，某个节点被展开或收起了，。这也是使用 <strong>adapter</strong> 的好处，因为这本该是流程里固定的一部分，但是在不同 <strong>Tree</strong> 组件下的回调通知函数可能不一样，但可以通过该 <strong>适配器模式</strong> 来达到逻辑复用，功能统一的目的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// semi design TreeFoundation.ts</span></span><br><span class="line"><span class="function"><span class="title">handleNodeExpand</span>(<span class="params">e: any, treeNode: BasicTreeNodeProps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; loadData &#125; = <span class="built_in">this</span>.getProps();</span><br><span class="line">    <span class="keyword">if</span> (!loadData &amp;&amp; (!treeNode.children || !treeNode.children.length)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; expandedKeys, data, expanded &#125; = <span class="built_in">this</span>.setExpandedStatus(treeNode);</span><br><span class="line">    <span class="comment">// 通知组件外部</span></span><br><span class="line">    <span class="built_in">this</span>._adapter.notifyExpand(expandedKeys, &#123;</span><br><span class="line">        expanded,</span><br><span class="line">        <span class="attr">node</span>: data,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">get</span> <span class="title">adapter</span>()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="attr">notifyExpand</span>: <span class="function">(<span class="params">expandedKeys, &#123; expanded: bool, node &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行回调函数</span></span><br><span class="line">            <span class="built_in">this</span>.props.onExpand &amp;&amp; <span class="built_in">this</span>.props.onExpand([...expandedKeys], &#123; <span class="attr">expanded</span>: bool, node &#125;);</span><br><span class="line">            <span class="comment">// 如果需要加载数据，则异步加载数据</span></span><br><span class="line">            <span class="keyword">if</span> (bool &amp;&amp; <span class="built_in">this</span>.props.loadData) &#123;</span><br><span class="line">                <span class="built_in">this</span>.onNodeLoad(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="renderTreeNode"><a href="#renderTreeNode" class="headerlink" title="renderTreeNode"></a>renderTreeNode</h2><p>因为 <strong>Tree</strong> 掌握了所有的基本数据，所以渲染节点的任务也应该交给他。</p>
<p>而在渲染之前，会通过一个 <strong>getTreeNodeProps</strong> 函数来扩展 <strong>treeNode</strong> 的基本信息，该函数接收的第二个参数是一个 <strong>treeState</strong> ，即当前 <strong>Tree</strong> 组件掌握的基本状态，在当前的设计中大概只有 <strong>keyEntities</strong> 和 <strong>expandedKeys</strong> 这两个，但是随着以后组件功能的完善，可能会出现 <strong>selectedKeys</strong> ， <strong>chosenKeys</strong> 等等数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getTreeNodeProps</span>(<span class="params">treeNode, treeState</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        keyEntities = &#123;&#125;,</span><br><span class="line">        expandedKeys = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    &#125; = treeState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; key &#125; = treeNode;</span><br><span class="line">    <span class="comment">// 从keyEntities里获取对应数据</span></span><br><span class="line">    <span class="keyword">const</span> data = keyEntities[key] || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...data,</span><br><span class="line">        <span class="comment">// 添加eventKey属性，因为key会与组件的key向冲突</span></span><br><span class="line">        <span class="attr">eventKey</span>: key,</span><br><span class="line">        <span class="comment">// 通过expandedKeys判断当前展开状态</span></span><br><span class="line">        <span class="attr">expanded</span>: expandedKeys.has(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">renderTreeNode</span>(<span class="params">treeNode</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = treeNode;</span><br><span class="line">    <span class="keyword">const</span> &#123; key &#125; = data;</span><br><span class="line">    <span class="keyword">const</span> &#123; keyEntities, expandedKeys &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> treeNodeProps = getTreeNodeProps(treeNode, &#123;</span><br><span class="line">        keyEntities,</span><br><span class="line">        expandedKeys</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">TreeNode</span> &#123;<span class="attr">...treeNodeProps</span>&#125; &#123;<span class="attr">...data</span>&#125; <span class="attr">key</span>=<span class="string">&#123;key&#125;</span> <span class="attr">data</span>=<span class="string">&#123;data&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此 <strong>Tree</strong> 组件的基本功能已经完成了，他主要有以下职责：</p>
<ol>
<li>保存 <strong>treeData</strong> 等节点信息</li>
<li>通过 <strong>getDerivedStateFromProps</strong> 声明周期转化成各种其他数据形式</li>
<li>处理节点被展开或收起的 <strong>onNodeExpand</strong> 事件处理函数</li>
<li>负责节点渲染函数，在渲染之前扩展 <strong>treeNode</strong> 信息</li>
<li>建立 <strong>Context</strong> 以供子组件使用数据</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; convertDataToEntities, flattenTreeData, getTreeNodeProps &#125; <span class="keyword">from</span> <span class="string">&#x27;./treeUtils&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> TreeContext <span class="keyword">from</span> <span class="string">&#x27;./treeContext&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> NodeList <span class="keyword">from</span> <span class="string">&#x27;./NodeList&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> TreeNode <span class="keyword">from</span> <span class="string">&#x27;./TreeNode&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> TreeFoundation <span class="keyword">from</span> <span class="string">&#x27;./TreeFoundation&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tree</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            <span class="attr">expandedKeys</span>: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">            <span class="attr">flattenNodes</span>: [],</span><br><span class="line">            <span class="attr">cachedFlattenNodes</span>: [],</span><br><span class="line">            <span class="attr">keyEntities</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">posEntities</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">entities</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在构造函数里创建foundation</span></span><br><span class="line">        <span class="built_in">this</span>.foundation = <span class="keyword">new</span> TreeFoundation(<span class="built_in">this</span>.adapter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">props, prevState</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; treeData &#125; = props;</span><br><span class="line">        <span class="keyword">const</span> &#123; expandedKeys &#125; = prevState;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> entities = convertDataToEntities(treeData, expandedKeys);</span><br><span class="line">        <span class="keyword">const</span> flattenNodes = flattenTreeData(treeData, expandedKeys);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newState = &#123;</span><br><span class="line">            <span class="attr">entities</span>: entities,</span><br><span class="line">            <span class="attr">keyEntities</span>: entities.keyEntities,</span><br><span class="line">            <span class="attr">posEntities</span>: entities.posEntities,</span><br><span class="line">            flattenNodes,</span><br><span class="line">            <span class="attr">cachedFlattenNodes</span>: prevState.flattenNodes</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span> <span class="title">adapter</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">getState</span>: <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.state[key];</span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">            <span class="attr">getStates</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.state;</span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">            <span class="attr">updateState</span>: <span class="function">(<span class="params">states, cb</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.setState(&#123; ...states &#125;, cb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">onNodeExpand</span>(<span class="params">e, treeNode</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 委托给foundation</span></span><br><span class="line">        <span class="built_in">this</span>.foundation.handleNodeExpand(e, treeNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">renderTreeNode</span>(<span class="params">treeNode</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; data &#125; = treeNode;</span><br><span class="line">        <span class="keyword">const</span> &#123; key &#125; = data;</span><br><span class="line">        <span class="keyword">const</span> &#123; keyEntities, expandedKeys &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">        <span class="keyword">const</span> treeNodeProps = getTreeNodeProps(treeNode, &#123;</span><br><span class="line">            keyEntities,</span><br><span class="line">            expandedKeys</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">TreeNode</span> &#123;<span class="attr">...treeNodeProps</span>&#125; &#123;<span class="attr">...data</span>&#125; <span class="attr">key</span>=<span class="string">&#123;key&#125;</span> <span class="attr">data</span>=<span class="string">&#123;data&#125;</span> /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            entities,</span><br><span class="line">            motionType,</span><br><span class="line">            motionKeys,</span><br><span class="line">            expandedKeys,</span><br><span class="line">            flattenNodes,</span><br><span class="line">            cachedFlattenNodes</span><br><span class="line">        &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">TreeContext.Provider</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">value</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">entities</span>,</span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">expandedKeys</span>,</span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onNodeExpand:</span> <span class="attr">this.onNodeExpand.bind</span>(<span class="attr">this</span>)</span></span></span><br><span class="line"><span class="tag"><span class="xml">                &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            &gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">NodeList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">motionType</span>=<span class="string">&#123;motionType&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">motionKeys</span>=<span class="string">&#123;motionKeys&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">flattenNodes</span>=<span class="string">&#123;flattenNodes&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">flattenList</span>=<span class="string">&#123;cachedFlattenNodes&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">renderTreeNode</span>=<span class="string">&#123;this.renderTreeNode.bind(this)&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">TreeContext.Provider</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Tree;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="TreeNode"><a href="#TreeNode" class="headerlink" title="TreeNode"></a>TreeNode</h1><p><strong>TreeNode</strong> 组件的任务比较简单，就是接收一个 <strong>treeNode</strong> 节点信息，然后进行展示。</p>
<p>比较关键的是因为是树形结构，所以需要体现层级关系，这个时候在之前 <strong>convertDataToEntities</strong> 函数里扩展的 <strong>level</strong> 信息就派上用场了，将 <strong>level</strong> 赋值到 <strong>className</strong> 里，然后通过 <strong>scss</strong> 等 <strong>css</strong> 工具的循环语法可以生成按照不同 <strong>level</strong> 而改变 <strong>padding-left</strong> 的样式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./styles/TreeNode.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FolderClose, FolderOpen, Notes, Right &#125; <span class="keyword">from</span> <span class="string">&#x27;@icon-park/react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> TreeContext <span class="keyword">from</span> <span class="string">&#x27;./treeContext&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> TreeNode = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        label,</span><br><span class="line">        level,</span><br><span class="line">        expanded,</span><br><span class="line">        children,</span><br><span class="line">    &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> treeContext = useContext(TreeContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> renderRightArrow = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 叶子节点，渲染空白icon，保持对齐</span></span><br><span class="line">        <span class="keyword">if</span> (!children || children.length === <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&#x27;24&#x27;</span> <span class="attr">height</span>=<span class="string">&#x27;24&#x27;</span> <span class="attr">viewBox</span>=<span class="string">&#x27;0 0 48 48&#x27;</span> /&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过expanded决定className</span></span><br><span class="line">        <span class="keyword">const</span> cls = <span class="string">`right <span class="subst">$&#123;expanded ? <span class="string">&#x27;expanded&#x27;</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> handleRightClick = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; onNodeExpand &#125; = treeContext;</span><br><span class="line">            e &amp;&amp; e.stopPropagation();</span><br><span class="line">            <span class="comment">// 调用Context里的onNodeExpand</span></span><br><span class="line">            onNodeExpand(e, props);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Right Arrow Icon</span></span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Right</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">className</span>=<span class="string">&#123;cls&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">theme</span>=<span class="string">&quot;outline&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">size</span>=<span class="string">&quot;24&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">fill</span>=<span class="string">&quot;#333&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">onClick</span>=<span class="string">&#123;handleRightClick&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> renderIcon = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 非叶子节点，通过expanded渲染对应icon</span></span><br><span class="line">        <span class="keyword">if</span> (children &amp;&amp; children.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> expanded</span><br><span class="line">                ? <span class="xml"><span class="tag">&lt;<span class="name">FolderOpen</span> <span class="attr">theme</span>=<span class="string">&quot;outline&quot;</span> <span class="attr">size</span>=<span class="string">&quot;24&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;#333&quot;</span> /&gt;</span></span></span><br><span class="line">                : <span class="xml"><span class="tag">&lt;<span class="name">FolderClose</span> <span class="attr">theme</span>=<span class="string">&quot;outline&quot;</span> <span class="attr">size</span>=<span class="string">&quot;24&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;#333&quot;</span> /&gt;</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 渲染叶子结点对应icon</span></span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Notes</span> <span class="attr">theme</span>=<span class="string">&quot;outline&quot;</span> <span class="attr">size</span>=<span class="string">&quot;24&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;#333&quot;</span> /&gt;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取对应level，在css里体现偏移量</span></span><br><span class="line">    <span class="keyword">const</span> cls = <span class="string">`tree-node tree-node-level-<span class="subst">$&#123;level&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">className</span>=<span class="string">&#123;cls&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;renderRightArrow()&#125;</span></span><br><span class="line"><span class="xml">            &#123;renderIcon()&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&#x27;tree-node-label&#x27;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> TreeNode;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.tree-node</span> &#123;</span><br><span class="line">    --tree-node-<span class="attribute">padding</span>: <span class="number">18px</span>;</span><br><span class="line">    <span class="attribute">list-style</span>: none;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">padding-bottom</span>: <span class="number">0.5em</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tree-node-level-0</span> &#123;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tree-node-level-1</span> &#123;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="built_in">calc</span>(<span class="built_in">var</span>(--tree-node-padding) * <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.tree-node-level-2</span> &#123;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="built_in">calc</span>(<span class="built_in">var</span>(--tree-node-padding) * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="NodeList"><a href="#NodeList" class="headerlink" title="NodeList"></a>NodeList</h1><p>有了上面的 <strong>Tree</strong> 和 <strong>TreeNode</strong> 组件，似乎一个 <strong>树形控件</strong> 已经完成了，只要在 <strong>Tree</strong> 里面通过 <strong>falttenNodes.map(node =&gt; renderTreeNode(node))</strong> 便可以按要求渲染出结果。</p>
<p>但是 <strong>semi design</strong> 还添加了 <strong>NodeList</strong> 这个组件，原因是要为节点的展开和收起添加动画，其思路如下：</p>
<ol>
<li>在触发 <strong>onNodeExpand</strong> 事件后，通过 <strong>getMotionKeys</strong> 获取需要动画处理的节点 <strong>keys</strong></li>
<li>将 <strong>motionKeys</strong> 注入 <strong>NodeList</strong> 组件中，通过 <strong>getDerivedStateFromProps</strong> 声明周期函数对 <strong>flattenNodes</strong> 处理</li>
<li>对于需要动画处理的节点统一放入 <strong>transitionRange</strong> 数组中，最后得出一个 <strong>transitionNodes</strong> 数组，其形式为： <strong>[node1, node2, [transitionRange], node3, …]</strong></li>
<li>将 <strong>transitionNodes</strong> 代替 <strong>flattenNodes</strong> 渲染，对于特定的 <strong>transitionRange</strong> 数组，将其放入 <strong>Collapse</strong> 组件</li>
<li>动画完成后触发回调函数 <strong>onMotionEnd</strong> ，将 <strong>transitionNodes</strong> 置为空数组</li>
<li><strong>NodeList</strong> 再渲染一遍，但此时 <strong>transitionNodes</strong> 为空，所以按照 <strong>flattenNodes</strong> 渲染</li>
</ol>
<h2 id="getDerivedStateFromProps-1"><a href="#getDerivedStateFromProps-1" class="headerlink" title="getDerivedStateFromProps"></a>getDerivedStateFromProps</h2><p>先看在 <strong>getDerivedStateFromProps</strong> 里对于 <strong>transitionNodes</strong> 的处理，其实就是找到第一个与 <strong>motionKeys</strong> 匹配的节点，记录下标值 <strong>rangeStart</strong> ，并把所有与 <strong>motionKeys</strong> 匹配的 <strong>treeNode</strong> 都放入 <strong>transitionRange</strong> ，其他放入 <strong>transitionNodes</strong> ，最后再进行 <strong>splice</strong> 插入操作。</p>
<p>但是这里需要考虑一个问题，当节点收起的时候，由于 <strong>motionKeys</strong> 的改变驱使 <strong>Tree</strong> 传入的 <strong>flattenNodes</strong> 改变，此时已经失去了要处理的动画节点了。这个时候 <strong>Tree</strong> 组件的 <strong>cachedFlattenNodes</strong> 就派上用场了，他缓存了上一次的 <strong>flattenNodes</strong>， 在 <strong>Tree</strong> 组件里将其一并传入 <strong>NodeList</strong> 。当 <strong>motionType</strong> 是 <strong>hide</strong> 的时候， <strong>NodeList</strong> 里取的是 <strong>flattenList</strong> 而不再是 <strong>flattenNodes</strong> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">props, prevState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; flattenNodes = [], flattenList = [], motionType, motionKeys &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> hasChanged = !isEqual(prevState.cachedMotionKeys, motionKeys) ||</span><br><span class="line">        !isEqual(prevState.cachedData.map(<span class="function"><span class="params">i</span> =&gt;</span> i.key), flattenNodes.map(<span class="function"><span class="params">i</span> =&gt;</span> i.key));</span><br><span class="line">    <span class="keyword">if</span> (!hasChanged)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> transitionNodes = [];</span><br><span class="line">    <span class="keyword">const</span> transitionRange = [];</span><br><span class="line">    <span class="keyword">let</span> rangeStart = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是hide，取得Tree的cachedFlattenNodes</span></span><br><span class="line">    <span class="keyword">const</span> lookUpTarget = motionType === <span class="string">&#x27;hide&#x27;</span> ? flattenList : flattenNodes;</span><br><span class="line">    lookUpTarget.forEach(<span class="function">(<span class="params">treeNode, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; key &#125; = treeNode;</span><br><span class="line">        <span class="comment">// 匹配，为需要处理的动画节点</span></span><br><span class="line">        <span class="keyword">if</span> (motionKeys.has(key)) &#123;</span><br><span class="line">            transitionRange.push(treeNode);</span><br><span class="line">            <span class="comment">// 需要待会在transitionNodes插入的下标</span></span><br><span class="line">            <span class="keyword">if</span> (rangeStart === -<span class="number">1</span>) &#123;</span><br><span class="line">                rangeStart = index;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            transitionNodes.push(treeNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 放入transitionRange</span></span><br><span class="line">    transitionNodes.splice(rangeStart, <span class="number">0</span>, transitionRange);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        transitionNodes,</span><br><span class="line">        <span class="attr">cachedData</span>: flattenNodes,</span><br><span class="line">        <span class="attr">cachedMotionKeys</span>: motionKeys,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="renderAnimatie"><a href="#renderAnimatie" class="headerlink" title="renderAnimatie"></a>renderAnimatie</h2><p>有了前面的思路，渲染函数这里的处理就比较简单了，通过 <strong>transitionNodes</strong> 的结构，把动画节点传入 <strong>Collapse</strong> 组件里：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">onMotionEnd</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">transitionNodes</span>: [] &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">renderAnimatie</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; flattenNodes, renderTreeNode, motionType &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; transitionNodes &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="comment">// 判断transitionNodes是否被清空</span></span><br><span class="line">    <span class="keyword">const</span> mapData = transitionNodes.length ? transitionNodes : flattenNodes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = mapData.map(<span class="function"><span class="params">treeNode</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 检查是否是动画节点</span></span><br><span class="line">        <span class="keyword">const</span> isMotionNode = <span class="built_in">Array</span>.isArray(treeNode);</span><br><span class="line">        <span class="keyword">if</span> (isMotionNode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (treeNode.length === <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 属于动画节点，传入Collapse组件</span></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="xml"><span class="tag">&lt;<span class="name">Collapse</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">motionType</span>=<span class="string">&#123;motionType&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onMotionEnd</span>=<span class="string">&#123;this.onMotionEnd.bind(this)&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                &gt;</span></span></span><br><span class="line"><span class="xml">                    &#123;treeNode.map(node =&gt; renderTreeNode(node))&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">Collapse</span>&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非动画节点，正常渲染</span></span><br><span class="line">            <span class="keyword">return</span> renderTreeNode(treeNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Collapse"><a href="#Collapse" class="headerlink" title="Collapse"></a>Collapse</h1><p>在 <strong>semi design</strong> 里，<strong>Collapse</strong> 组件引用了内部的 <strong>Transition</strong> ，然后在 <strong>Transition</strong> 里又引用了 <strong>Animation</strong> 组件。因为此次的重点不在于动画的处理，所以就不深入研究 <strong>Transition</strong> 和 <strong>Animation</strong> 组件了。</p>
<p>但是当使用 <strong>react-transition-group</strong> 这个动画库的时候，发现 <strong>semi design</strong> 把动画的处理分为了 <strong>motionKeys</strong> 驱动渲染和 <strong>动画结束</strong> 重新渲染两部分，导致 <strong>CSSTransition</strong> 的 <strong>in</strong> 属性不可用， <strong>TransitionGroup</strong> 主动管理节点增删的动画又不如预期。因此采用了自己封装 <strong>Collapse</strong> 组件，加上 <strong>react-spring</strong> 动画库的方案。</p>
<h2 id="检测元素高度"><a href="#检测元素高度" class="headerlink" title="检测元素高度"></a>检测元素高度</h2><p>之前实现 <strong>Modal</strong> 弹窗组件的时候提到过，<strong>css</strong> 里的动画不支持从 <strong>height: 0</strong> 到 <strong>height: auto</strong> 过度。但是可以利用 <strong>max-height</strong> 来进行处理，只不过设置 <strong>max-height</strong> 需要获取元素的高度，而在 <strong>React</strong> 中检测元素高度的方法只能通过 <strong>ref</strong> ，但是 <strong>Collapse</strong> 里面拿到的 <strong>children</strong> 属性又是 <strong>React Element</strong> ，不是正常的 <strong>JSX</strong> 语法，不能在其上面添加 <strong>ref</strong> 。</p>
<p>再仔细阅读 <strong>semi design</strong> 的源码，就会发现在 <strong>Collapse</strong> 组件的 <strong>renderChildren</strong> 方法里，使用了 <strong>&lt;div&gt;</strong> 标签将 <strong>children</strong> 包裹了起来，然后传入 <strong>ref</strong> ，并且传入的还是一个函数，将检测元素高度的工作委托给了 <strong>setHeight</strong> 函数，并把值保存在 <strong>maxHeight</strong> 里面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> setHeight = useCallback(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 检测到scrollHeight</span></span><br><span class="line">    <span class="keyword">const</span> currHeight = node &amp;&amp; node.scrollHeight;</span><br><span class="line">    <span class="keyword">if</span> (currHeight &amp;&amp; maxHeight !== currHeight) &#123;</span><br><span class="line">        <span class="comment">// 设置maxHeight</span></span><br><span class="line">        setMaxHeight(currHeight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, [left]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> renderChildren = <span class="function">(<span class="params">transitionStyle: TransitionStyle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> transition =</span><br><span class="line">        transitionStyle &amp;&amp; <span class="keyword">typeof</span> transitionStyle === <span class="string">&#x27;object&#x27;</span> ? formatStyle(transitionStyle) : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> style = &#123;</span><br><span class="line">        <span class="attr">overflow</span>: <span class="string">&#x27;hidden&#x27;</span>,</span><br><span class="line">        <span class="attr">maxHeight</span>: open ? <span class="string">&#x27;none&#x27;</span> : <span class="number">0</span>,</span><br><span class="line">        ...transition,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 用&lt;div&gt;包裹，并传入ref</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span> <span class="attr">className</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">cssClasses.PREFIX</span>&#125;<span class="attr">-wrapper</span>`&#125; <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;setHeight&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="react-spring"><a href="#react-spring" class="headerlink" title="react-spring"></a>react-spring</h2><p>有了元素的高度，那么就可以利用 <strong>react-spring</strong> 来创建动画了，通过 <strong>useSpring</strong> 为节点的展开和收起创建两个 <strong>props</strong> ，然后当 <strong>Collapse</strong> 组件的 <strong>maxHeight</strong> 值有效的时候渲染动画：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hideProps = useSpring(&#123;</span><br><span class="line">    <span class="attr">to</span>: &#123; <span class="attr">maxHeight</span>: <span class="number">0</span> &#125;,</span><br><span class="line">    <span class="attr">from</span>: &#123; maxHeight &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> showProps = useSpring(&#123;</span><br><span class="line">    <span class="attr">to</span>: &#123; maxHeight &#125;,</span><br><span class="line">    <span class="attr">from</span>: &#123; <span class="attr">maxHeight</span>: <span class="number">0</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (maxHeight) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">animated.div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">style</span>=<span class="string">&#123;motionType</span> === <span class="string">&#x27;show&#x27;</span> ? <span class="attr">showProps</span> <span class="attr">:</span> <span class="attr">hideProps</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">className</span>=<span class="string">&#x27;collapse&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        &gt;</span></span></span><br><span class="line"><span class="xml">            &#123;children&#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">animated.div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="onRest"><a href="#onRest" class="headerlink" title="onRest"></a>onRest</h2><p>根据前面的思路，这里还有一个工作没有完成，那就是在动画结束后，重新把 <strong>transitionNodes</strong> 置空，让 <strong>NodeList</strong> 渲染 <strong>flattenNodes</strong> 。 所以在 <strong>Collapse</strong> 组件里需要负责监听动画的结束，然后执行 <strong>NodeList</strong> 传入的 <strong>onMotionEnd</strong> 函数。</p>
<p>在原生的 <strong>DOM</strong> 事件中，可以通过 <strong>onAnimationEnd</strong> 来进行事件的监听，而在 <strong>react-spring</strong> 中提供了 <strong>onRest</strong> 事件，在动画的停止的时候会执行对应的回调函数，而此次动画因为只有两帧，所以停止了就相当于动画结束了，所以在前面的 <strong>useSpring</strong> 里加上对应的回调函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hideProps = useSpring(&#123;</span><br><span class="line">    <span class="attr">to</span>: &#123; <span class="attr">maxHeight</span>: <span class="number">0</span> &#125;,</span><br><span class="line">    <span class="attr">from</span>: &#123; <span class="attr">maxHeight</span>: maxHeight + <span class="number">50</span> &#125;,</span><br><span class="line">    <span class="comment">// 根据motionType对应执行，防止onMotionEnd多次执行</span></span><br><span class="line">    <span class="attr">onRest</span>: <span class="function">() =&gt;</span> &#123; motionType === <span class="string">&#x27;hide&#x27;</span> &amp;&amp; onMotionEnd &amp;&amp; onMotionEnd() &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> showProps = useSpring(&#123;</span><br><span class="line">    <span class="attr">to</span>: &#123; <span class="attr">maxHeight</span>: maxHeight + <span class="number">50</span> &#125;,</span><br><span class="line">    <span class="attr">from</span>: &#123; <span class="attr">maxHeight</span>: <span class="number">0</span> &#125;,</span><br><span class="line">    <span class="attr">onRest</span>: <span class="function">() =&gt;</span> &#123; motionType === <span class="string">&#x27;show&#x27;</span> &amp;&amp; onMotionEnd &amp;&amp; onMotionEnd() &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h1><p>通过此次对 <strong>Tree</strong> 树形控件的复盘，主要有以下收获：</p>
<ol>
<li>对于多节点组件如何进行渲染控制，数据结构的各种转换。</li>
<li>通过 <strong>getDerivedStateFromProps</strong> 生命周期函数对 <strong>state</strong> 进行数据派生</li>
<li><strong>semi design</strong> 的 <strong>F / A 架构</strong></li>
<li>如何通过 <strong>ref</strong> 检测 <strong>children</strong> 的元素高度</li>
<li>动画处理的一些小技巧，如 <strong>max-height</strong> 和 <strong>onAnimationEnd</strong></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Component/" rel="tag"># Component</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/12/04/source%20code%20-%20react-redux/" rel="prev" title="source code - react-redux">
      <i class="fa fa-chevron-left"></i> source code - react-redux
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/10/source%20code%20-%20axios/" rel="next" title="source code - axios">
      source code - axios <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#preview"><span class="nav-number">1.</span> <span class="nav-text">preview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#data-structure"><span class="nav-number">2.</span> <span class="nav-text">data structure</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E6%96%B9%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text">渲染方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#F-A-%E6%9E%B6%E6%9E%84"><span class="nav-number">4.</span> <span class="nav-text">F &#x2F; A 架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tree"><span class="nav-number">5.</span> <span class="nav-text">Tree</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Structure"><span class="nav-number">5.1.</span> <span class="nav-text">Data Structure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getDerivedStateFromProps"><span class="nav-number">5.2.</span> <span class="nav-text">getDerivedStateFromProps</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#convertDataToEntities"><span class="nav-number">5.2.1.</span> <span class="nav-text">convertDataToEntities</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flattenTreeData"><span class="nav-number">5.2.2.</span> <span class="nav-text">flattenTreeData</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Foundation"><span class="nav-number">5.3.</span> <span class="nav-text">Foundation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderTreeNode"><span class="nav-number">5.4.</span> <span class="nav-text">renderTreeNode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">5.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TreeNode"><span class="nav-number">6.</span> <span class="nav-text">TreeNode</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NodeList"><span class="nav-number">7.</span> <span class="nav-text">NodeList</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#getDerivedStateFromProps-1"><span class="nav-number">7.1.</span> <span class="nav-text">getDerivedStateFromProps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderAnimatie"><span class="nav-number">7.2.</span> <span class="nav-text">renderAnimatie</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Collapse"><span class="nav-number">8.</span> <span class="nav-text">Collapse</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B%E5%85%83%E7%B4%A0%E9%AB%98%E5%BA%A6"><span class="nav-number">8.1.</span> <span class="nav-text">检测元素高度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-spring"><span class="nav-number">8.2.</span> <span class="nav-text">react-spring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#onRest"><span class="nav-number">8.3.</span> <span class="nav-text">onRest</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">9.</span> <span class="nav-text">小结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ken</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Ken-HH24" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ken-HH24" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ken</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
